---
# tasks file for app-cryocare
- name: Check if the Singularity image has been built
  stat:
    path: /opt/cryocare/cryoCARE_v0.1.1.simg
  register: singularity_image_check

- name: Check if MotionCor has been downloaded
  stat:
    path: "/opt/cryocare/example/MotionCor2_v1.3.1-Cuda101"
  register: motioncor_check


- name: Install Singularity pre-reqs
  yum:
    name: "{{ item }}"
    state: present
  become: yes
  loop:
    - "@Development Tools"
    - openssl-devel
    - libuuid-devel
    - libseccomp-devel
    - wget
    - squashfs-tools
    - golang

- name: Install Singularity
  yum:
    name: "{{ item }}"
    state: present
  become: yes
  loop:
    - epel-release
    - singularity-runtime 
    - singularity

- name: Ensure that git is installed.
  package:
    name: git
    state: present
  become: yes

- name: Clone down the CryoCARE git repo
  git:
    repo: "{{ cryocare_clone_repo }}"
    dest: /opt/cryocare
    version: "{{ cryocare_version }}"
  become: yes

- name: Build the CryoCARE Singularity image
  shell: |
    cd /opt/cryocare
    singularity build cryoCARE_v0.1.1.simg cryoCARE.Singularity
  become: yes
  when: not singularity_image_check.stat.exists

- name: Download MotionCor2
  get_url:
    url: "{{ motioncor_url }}"
    dest: /tmp/MotionCor2_1.3.1.zip
  become: yes
  when: not motioncor_check.stat.exists

- name: Unzip MotionCor2
  unarchive:
    src: /tmp/MotionCor2_1.3.1.zip
    remote_src: yes
    dest: /opt/cryocare/example
  become: yes
  when: not motioncor_check.stat.exists

- name: Make symlink for MotionCor2
  file:
    state: link
    path: /opt/cryocare/example/MotionCor2_1.3.0-Cuda101
    src: /opt/cryocare/example/MotionCor2_v1.3.1-Cuda101
  become: yes

- name: Add in bash function wrapper for CryoCARE
  copy:
    src: cryocare.sh
    dest: /etc/profile.d/cryocare.sh 
  become: yes
